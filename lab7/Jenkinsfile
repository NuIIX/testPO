pipeline {
    agent any
    environment {
        GIT_SSH_COMMAND = "ssh -o StrictHostKeyChecking=no"
        PROJECT_DIR = "${WORKSPACE}"
        QEMU_IMAGE = "/var/jenkins_home/workspace/romulus/obmc-phosphor-image-romulus-20250927014348.static.mtd"
        WEBUI_RESULTS = "${PROJECT_DIR}/results/webui_tests.xml"
        API_RESULTS = "${PROJECT_DIR}/results/api_tests.xml"
        LOAD_RESULTS = "${PROJECT_DIR}/results/load_tests.xml"
    }
    stages {
        stage('Prepare Environment') {
            steps {
                echo "Подготовка окружения"
                sh """
                mkdir -p ${PROJECT_DIR}/results
                mkdir -p /var/jenkins_home/.ssh
                ssh-keyscan github.com >> /var/jenkins_home/.ssh/known_hosts 2>/dev/null || true
                chmod 644 /var/jenkins_home/.ssh/known_hosts || true

                apt-get update
                apt-get install -y python3 python3-pip python3-venv python3-full curl wget qemu-system-arm chromium chromium-driver
                python3 -m venv ${PROJECT_DIR}/venv
                . ${PROJECT_DIR}/venv/bin/activate
                pip install --upgrade pip
                pip install pytest requests urllib3 selenium locust webdriver-manager
                """
            }
        }

        stage('Start QEMU') {
            steps {
                echo "Запуск QEMU с OpenBMC"
                sh """
                pkill qemu-system-arm || true
                rm -f qemu.pid
                sleep 2

                nohup qemu-system-arm -m 256 -M romulus-bmc -nographic \
                    -drive file=${QEMU_IMAGE},format=raw,if=mtd \
                    -net nic \
                    -net user,hostfwd=tcp::2222-:22,hostfwd=tcp::2443-:443,hostfwd=udp::2623-:623,hostname=qemu \
                    > ${PROJECT_DIR}/results/qemu.log 2>&1 &

                echo \$! > qemu.pid
                sleep 10

                if ! ps -p \$(cat qemu.pid) > /dev/null; then
                    echo "QEMU не запущен!"
                    cat ${PROJECT_DIR}/results/qemu.log
                    exit 1
                fi

                echo "Ожидание OpenBMC на порту 2443..."
                timeout=180
                elapsed=0
                while ! curl -k --silent --output /dev/null --connect-timeout 5 https://localhost:2443/redfish/v1; do
                    sleep 10
                    elapsed=\$((elapsed+10))
                    if [ \$elapsed -ge \$timeout ]; then
                        echo "OpenBMC не поднялся за \$timeout секунд"
                        cat ${PROJECT_DIR}/results/qemu.log
                        exit 1
                    fi
                    printf "."
                done
                echo "\\nOpenBMC готов к работе"
                """
            }
        }

        stage('Run WebUI Tests') {
            steps {
                echo "Запуск WebUI тестов OpenBMC"
                sh """
                cd ${PROJECT_DIR}
                . ${PROJECT_DIR}/venv/bin/activate
                python -m pytest lab7/tests/unified_openbmc_tests.py::TestWebUI -v --junitxml=${WEBUI_RESULTS} || true
                ls -la ${PROJECT_DIR}/results/
                """
            }
            post {
                always {
                    script {
                        if (fileExists('results/webui_tests.xml')) {
                            junit skipPublishingChecks: true, allowEmptyResults: true, testResults: 'results/webui_tests.xml'
                        }
                    }
                    archiveArtifacts artifacts: 'results/webui_tests.xml', fingerprint: true, allowEmptyArchive: true
                    archiveArtifacts artifacts: 'results/*.png', fingerprint: true, allowEmptyArchive: true
                }
            }
        }

        stage('Run API Tests') {
            steps {
                echo "Запуск автотестов для OpenBMC"
                sh """
                cd ${PROJECT_DIR}
                . ${PROJECT_DIR}/venv/bin/activate
                python -m pytest lab7/tests/unified_openbmc_tests.py::TestRedfishAPI -v --junitxml=${API_RESULTS} || true
                ls -la ${PROJECT_DIR}/results/
                """
            }
            post {
                always {
                    script {
                        if (fileExists('results/api_tests.xml')) {
                            junit skipPublishingChecks: true, allowEmptyResults: true, testResults: 'results/api_tests.xml'
                        }
                    }
                    archiveArtifacts artifacts: 'results/api_tests.xml', fingerprint: true, allowEmptyArchive: true
                }
            }
        }

        stage('Run Load Tests') {
            steps {
                echo "Запуск нагрузочного тестирования OpenBMC"
                sh """
                cd ${PROJECT_DIR}
                . ${PROJECT_DIR}/venv/bin/activate
                PYTHONPATH=. python -c "
from lab7.tests.unified_openbmc_tests import run_load_test
import sys
success = run_load_test()
sys.exit(0 if success else 1)
" || true
                ls -la ${PROJECT_DIR}/results/
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'results/load_tests.xml', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            echo "Очистка ресурсов"
            sh """
            if [ -f qemu.pid ]; then
                kill \$(cat qemu.pid) || true
                rm -f qemu.pid
            fi
            pkill qemu-system-arm || true
            """
        }
        success {
            echo "Pipeline выполнен успешно"
        }
        failure {
            echo "Pipeline завершился с ошибками"
        }
    }
}
